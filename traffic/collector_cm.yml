apiVersion: v1
kind: ConfigMap
metadata:
  name: collector-conf
  namespace: traffic
data:
  fluent-bit.conf: |
    [SERVICE]
      Flush         1
      Parsers_File  parsers.conf
      Log_Level     info

    [INPUT]
      Name                tail
      Tag                 kube.*
      Path                /var/log/containers/*.log
      Parser              cri
      Skip_Long_Lines     On
      Refresh_Interval    5
      Rotate_Wait         5
      Mem_Buf_Limit       50MB
      Read_From_Head      Off

    [FILTER]
      Name                kubernetes
      Match               kube.*
      Kube_URL            https://kubernetes.default.svc:443
      Merge_Log           On
      Keep_Log            On
      Kube_Tag_Prefix     kube.var.log.containers.

    [FILTER]
      Name   grep
      Match  kube.*
      Regex  $kubernetes['labels']['app.kubernetes.io/name']  ^ingress-nginx$

    [OUTPUT]
      Name    forward
      Match   kube.*
      Host    aggregator.traffic.svc.cluster.local
      Port    24224

  parsers.conf: |
    [PARSER]
      Name        cri
      Format      regex
      Regex       ^(?<time>[^ ]+) (?<stream>stdout|stderr) (?<flags>[^ ]*) (?<log>.*)$
      Time_Key    time
      Time_Format %Y-%m-%dT%H:%M:%S.%L%z

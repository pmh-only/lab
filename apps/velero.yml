apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: velero
  namespace: argocd
spec:
  destination:
    namespace: velero
    server: https://kubernetes.default.svc
  ignoreDifferences:
    - jsonPointers:
        - /data
      kind: Secret
  project: default
  source:
    chart: velero
    helm:
      valuesObject:
        deployNodeAgent: true
        snapshotsEnabled: false
        configuration:
          repositoryMaintenanceJob:
            repositoryConfigData:
              global:
                keepLatestMaintenanceJobs: 0
          defaultVolumesToFsBackup: true
          backupStorageLocation:
            - name: default
              provider: aws
              bucket: velero
              default: true
              credential:
                name: velero
                key: rustfs
              config:
                region: us-east-1
                s3ForcePathStyle: true
                s3Url: http://pmhraspberry.tailscale.svc.cluster.local:9000
                insecureSkipTLSVerify: true
        initContainers:
          - name: velero-plugin-for-aws
            image: velero/velero-plugin-for-aws:latest
            imagePullPolicy: IfNotPresent
            volumeMounts:
              - mountPath: /target
                name: plugins
        schedules:
          backup:
            disabled: false
            schedule: "0 */6 * * *"
            useOwnerReferencesInBackup: false
            paused: false
            skipImmediately: false
            template:
              ttl: "720h"
              storageLocation: default
              defaultVolumesToFsBackup: true
              uploaderConfig:
                parallelFilesUpload: 16
    repoURL: https://vmware-tanzu.github.io/helm-charts
    targetRevision: x
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - PruneLast=true
      - ApplyOutOfSyncOnly=true
      - RespectIgnoreDifferences=true
      - CreateNamespace=true
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: velero-ui
  namespace: argocd
spec:
  destination:
    namespace: velero
    server: https://kubernetes.default.svc
  ignoreDifferences:
    - jsonPointers:
        - /data
      kind: Secret
  project: default
  source:
    chart: velero-ui
    helm:
      valuesObject:
        env:
          - name: BASIC_AUTH_ENABLED
            value: "false"
          - name: OAUTH_AUTH_ENABLED
            value: "true"
          - name: OAUTH_NAME
            value: pmh.codes
          - name: OAUTH_AUTHORIZATION_URL
            value: https://auth.pmh.codes/application/o/authorize/
          - name: OAUTH_USER_INFO_URL
            value: http://authentik-service.authentik.svc.cluster.local:9000/application/o/userinfo/
          - name: OAUTH_TOKEN_URL
            value: http://authentik-service.authentik.svc.cluster.local:9000/application/o/token/
          - name: OAUTH_CLIENT_ID
            value: jiqFkzGXFxXeRcYUJNRkPnwvh6acq0a0kCwAy0R9
          - name: OAUTH_CLIENT_SECRET
            valueFrom:
              secretKeyRef:
                name: velero-ui-secrets
                key: OAUTH_CLIENT_SECRET
          - name: OAUTH_REDIRECT_URI
            value: https://velero.pmh.codes/login
    repoURL: https://helm.otwld.com
    targetRevision: x
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - PruneLast=true
      - ApplyOutOfSyncOnly=true
      - RespectIgnoreDifferences=true
      - CreateNamespace=true
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: velero-ui-configs
  namespace: argocd
spec:
  destination:
    namespace: velero
    server: https://kubernetes.default.svc
  project: default
  source:
    path: velero-ui_configs
    repoURL: git@github.com:pmh-only/lab.git
    targetRevision: HEAD
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - PruneLast=true
      - ApplyOutOfSyncOnly=true
      - CreateNamespace=true

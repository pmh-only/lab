apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: velero
  namespace: argocd
spec:
  destination:
    namespace: velero
    server: https://kubernetes.default.svc
  ignoreDifferences:
    - jsonPointers:
        - /data
      kind: Secret
  project: default
  source:
    chart: velero
    helm:
      valuesObject:
        deployNodeAgent: true
        snapshotsEnabled: false
        configuration:
          repositoryMaintenanceJob:
            repositoryConfigData:
              global:
                keepLatestMaintenanceJobs: 0
          defaultVolumesToFsBackup: true
          backupStorageLocation:
            - name: default
              provider: aws
              bucket: velero
              default: true
              credential:
                name: velero
                key: rustfs
              config:
                region: us-east-1
                s3ForcePathStyle: true
                s3Url: http://pmhraspberry.tailscale.svc.cluster.local:9000
                insecureSkipTLSVerify: true
        initContainers:
          - name: velero-plugin-for-aws
            image: velero/velero-plugin-for-aws:latest
            imagePullPolicy: IfNotPresent
            volumeMounts:
              - mountPath: /target
                name: plugins
        schedules:
          backup:
            disabled: false
            schedule: "0 */6 * * *"
            useOwnerReferencesInBackup: false
            paused: false
            skipImmediately: false
            template:
              ttl: "720h"
              storageLocation: default
              defaultVolumesToFsBackup: true
              uploaderConfig:
                parallelFilesUpload: 16
    repoURL: https://vmware-tanzu.github.io/helm-charts
    targetRevision: x
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - PruneLast=true
      - ApplyOutOfSyncOnly=true
      - RespectIgnoreDifferences=true
      - CreateNamespace=true

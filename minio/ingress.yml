apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: minio-s3-route
spec:
  parentRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: main
      namespace: gateway
  hostnames:
    - s3.pmh.codes
    - "*.s3.pmh.codes"
  rules:
    - backendRefs:
        - group: ""
          kind: Service
          name: minio-service
          port: 9000
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: minio-bucket-route
spec:
  parentRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: main
      namespace: gateway
  hostnames:
    - pmh.codes
    - "*.pmh.codes"
    - "*.cdn.pmh.codes"
  rules:
    - backendRefs:
        - group: ""
          kind: Service
          name: minio-service
          port: 9000
---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: EnvoyExtensionPolicy
metadata:
  name: minio-bucket-routing
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: minio-bucket-route
  lua:
    - type: Inline
      inline: |
        function envoy_on_request(request_handle)
          local host = request_handle:headers():get(":authority") or ""
          local path = request_handle:headers():get(":path") or "/"

          -- Skip S3 API endpoints
          if host:match("s3%.pmh%.codes$") then return end

          -- Extract bucket from hostname
          local bucket, cdn = host:match("^([^.]+)(%.cdn)?%.pmh%.codes$")

          if not bucket then
            bucket = "www"
          elseif cdn then
            bucket = "c-" .. bucket
          elseif #bucket < 3 or bucket:sub(1, 4) == "xn--" then
            bucket = "a-" .. bucket
          end

          -- Root path: serve index.html
          if path == "/" then
            request_handle:headers():replace(":path", "/" .. bucket .. "/index.html")
            request_handle:headers():replace("host", bucket .. ".s3.pmh.codes")
          else
            -- Non-root: prepend bucket to path
            request_handle:headers():replace(":path", "/" .. bucket .. path)
          end
        end

        function envoy_on_response(response_handle)
          local status = response_handle:headers():get(":status")
          if status == "400" or status == "401" or status == "403" or status == "404" then
            response_handle:headers():replace(":status", "302")
            response_handle:headers():add("location", "https://pmh.codes")
            local body = response_handle:body(true)
            if body then
              body:setBytes("")
            end
          end
        end

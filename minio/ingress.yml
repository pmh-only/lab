apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: minio-s3-route
spec:
  parentRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: main
      namespace: gateway
  hostnames:
    - s3.pmh.codes
    - "*.s3.pmh.codes"
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - group: ""
          kind: Service
          name: minio-service
          port: 9000
          weight: 1
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: minio-bucket-route
spec:
  parentRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: main
      namespace: gateway
  hostnames:
    - pmh.codes
    - "*.pmh.codes"
    - "*.cdn.pmh.codes"
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - group: ""
          kind: Service
          name: minio-service
          port: 9000
          weight: 1
---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: EnvoyExtensionPolicy
metadata:
  name: minio-bucket-routing
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: minio-bucket-route
  lua:
    - type: Inline
      inline: |
        function envoy_on_request(request_handle)
          local host = request_handle:headers():get(":authority") or ""
          local path = request_handle:headers():get(":path") or "/"

          if host:match("s3%.pmh%.codes$") then return end

          local bucket = nil
          local cdn_sub = host:match("^([^.]+)%.cdn%.pmh%.codes$")
          if cdn_sub then
            bucket = "c-" .. cdn_sub
          else
            bucket = host:match("^([^.]+)%.pmh%.codes$")
            if bucket then
              if #bucket < 3 or bucket:sub(1, 4) == "xn--" then
                bucket = "a-" .. bucket
              end
            else
              bucket = "www"
            end
          end

          local target_path = path == "/" and "/index.html" or path
          local target_host = bucket .. ".s3.pmh.codes"

          if host == "pmh.codes" or host == "www.pmh.codes" then
            local probe_ok, probe_headers = pcall(function()
              return request_handle:httpCall(
                "s3-probe-cluster",
                {
                  [":method"]    = "HEAD",
                  [":path"]      = target_path,
                  [":authority"] = target_host,
                  ["host"]       = target_host,
                },
                "",
                3000
              )
            end)

            local s3_status = "pcall-failed"
            local error_msg = "none"
            if probe_ok and probe_headers then
              s3_status = probe_headers[":status"] or "no-status"
            elseif not probe_ok then
              -- probe_headers contains the error message when pcall fails
              error_msg = tostring(probe_headers)
              s3_status = "pcall-error"
            end

            -- Always return debug info
            request_handle:respond(
              {
                [":status"]              = "200",
                ["content-type"]         = "text/plain",
                ["x-debug-probe-ok"]     = tostring(probe_ok),
                ["x-debug-s3-status"]    = s3_status,
                ["x-debug-error"]        = error_msg,
                ["x-debug-target-host"]  = target_host,
                ["x-debug-target-path"]  = target_path,
              },
              "probe_ok=" .. tostring(probe_ok) ..
              "\ns3_status=" .. s3_status ..
              "\nerror=" .. error_msg ..
              "\ntarget=" .. target_host .. target_path
            )
            return
          end

          request_handle:headers():replace("host", target_host)
          request_handle:headers():replace(":path", target_path)
        end

        function envoy_on_response(response_handle)
          local status = response_handle:headers():get(":status")
          if status == "400" or status == "401" or status == "403" or status == "404" then
            response_handle:headers():replace(":status", "302")
            response_handle:headers():add("location", "https://pmh.codes")
            local body = response_handle:body(true)
            if body then body:setBytes("") end
          end
        end

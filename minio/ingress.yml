apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: minio-s3-route
spec:
  parentRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: main
      namespace: gateway
  hostnames:
    - s3.pmh.codes
    - "*.s3.pmh.codes"
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - group: ""
          kind: Service
          name: minio-service
          port: 9000
          weight: 1
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: minio-bucket-route
spec:
  parentRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: main
      namespace: gateway
  hostnames:
    - pmh.codes
    - "*.pmh.codes"
    - "*.cdn.pmh.codes"
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - group: ""
          kind: Service
          name: minio-service
          port: 9000
          weight: 1
---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: EnvoyExtensionPolicy
metadata:
  name: minio-bucket-routing
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: minio-bucket-route
  lua:
    - type: Inline
      inline: |
        function envoy_on_request(request_handle)
          local host = request_handle:headers():get(":authority") or ""
          local path = request_handle:headers():get(":path") or "/"

          if host:match("s3%.pmh%.codes$") then return end

          local bucket = nil
          local cdn_sub = host:match("^([^.]+)%.cdn%.pmh%.codes$")
          if cdn_sub then
            bucket = "c-" .. cdn_sub
          else
            bucket = host:match("^([^.]+)%.pmh%.codes$")
            if bucket then
              if #bucket < 3 or bucket:sub(1, 4) == "xn--" then
                bucket = "a-" .. bucket
              end
            else
              bucket = "www"
            end
          end

          local target_path = path == "/" and "/index.html" or path
          local target_host = bucket .. ".s3.pmh.codes"

          if host == "pmh.codes" or host == "www.pmh.codes" then
            local probe_ok, probe_headers = pcall(function()
              return request_handle:httpCall(
                "s3-probe-cluster",
                {
                  [":method"]    = "HEAD",
                  [":path"]      = target_path,
                  [":authority"] = target_host,
                  ["host"]       = target_host,
                },
                "",
                3000
              )
            end)

            local s3_status = (probe_ok and probe_headers) and probe_headers[":status"] or "500"

            if s3_status:match("^[45]") then
              local method = request_handle:headers():get(":method") or "GET"
              local fb_ok, fb_headers, fb_body = pcall(function()
                return request_handle:httpCall(
                  "go-go-cluster",
                  {
                    [":method"]    = method,
                    [":path"]      = path,
                    [":authority"] = "go-service.go.svc.cluster.local",
                    ["host"]       = "go-service.go.svc.cluster.local",
                  },
                  "",
                  5000
                )
              end)

              if fb_ok and fb_headers then
                request_handle:respond(fb_headers, fb_body or "")
              else
                request_handle:respond(
                  {[":status"] = "502", ["content-type"] = "text/plain"},
                  "Bad Gateway"
                )
              end
              return
            end

            request_handle:headers():replace("host", target_host)
            request_handle:headers():replace(":path", target_path)
            return
          end

          request_handle:headers():replace("host", target_host)
          request_handle:headers():replace(":path", target_path)
        end

        function envoy_on_response(response_handle)
          local status = response_handle:headers():get(":status")

          if status == "400" or status == "401" or status == "403" or status == "404" then
            response_handle:headers():replace(":status", "302")
            response_handle:headers():add("location", "https://pmh.codes")
            local body = response_handle:body(true)
            if body then body:setBytes("") end
          end
        end

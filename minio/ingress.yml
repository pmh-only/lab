apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: minio-s3-route
spec:
  parentRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: main
      namespace: gateway
  hostnames:
    - s3.pmh.codes
    - "*.s3.pmh.codes"
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - group: ""
          kind: Service
          name: minio-service
          port: 9000
          weight: 1
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: minio-bucket-route
spec:
  parentRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: main
      namespace: gateway
  hostnames:
    - pmh.codes
    - "*.pmh.codes"
    - "*.cdn.pmh.codes"
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - group: ""
          kind: Service
          name: minio-service
          port: 9000
          weight: 1
---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: EnvoyExtensionPolicy
metadata:
  name: minio-bucket-routing
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: minio-bucket-route
  lua:
    - type: Inline
      inline: |
        function envoy_on_request(request_handle)
          local host = request_handle:headers():get(":authority") or ""
          local path = request_handle:headers():get(":path") or "/"

          -- Skip S3 API endpoints
          if host:match("s3%.pmh%.codes$") then return end

          -- Extract bucket from hostname
          local bucket = nil
          local cdn_sub = host:match("^([^.]+)%.cdn%.pmh%.codes$")
          if cdn_sub then
            bucket = "c-" .. cdn_sub
          else
            bucket = host:match("^([^.]+)%.pmh%.codes$")
            if bucket then
              if #bucket < 3 or bucket:sub(1, 4) == "xn--" then
                bucket = "a-" .. bucket
              end
            else
              bucket = "www"
            end
          end

          request_handle:headers():replace("host", bucket .. ".s3.pmh.codes")

          -- Root path: serve index.html
          if path == "/" then
            request_handle:headers():replace(":path", "/index.html")
          end
        end

        function envoy_on_response(response_handle)
          local status = response_handle:headers():get(":status")
          if status == "400" or status == "401" or status == "403" or status == "404" then
            response_handle:headers():replace(":status", "302")
            response_handle:headers():add("location", "https://pmh.codes")
            local body = response_handle:body(true)
            if body then
              body:setBytes("")
            end
          end
        end
